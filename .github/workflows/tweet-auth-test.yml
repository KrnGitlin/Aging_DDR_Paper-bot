name: Tweet Auth Test

on:
  workflow_dispatch:
    inputs:
      text:
        description: "Text to post (keep short; will be public)"
        required: false
        default: "Hello from Aging–DDR bot (setup test)."

permissions:
  contents: read

jobs:
  test-tweet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Tweepy
        run: |
          python -m pip install --upgrade pip
          pip install tweepy>=4.14.0 python-dotenv

      - name: Post a test tweet using v2 client
        env:
          TWITTER_CONSUMER_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          TWITTER_CONSUMER_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_CLIENT_ID: ${{ secrets.TWITTER_CLIENT_ID }}
          TWITTER_CLIENT_SECRET: ${{ secrets.TWITTER_CLIENT_SECRET }}
          TWITTER_REFRESH_TOKEN: ${{ secrets.TWITTER_REFRESH_TOKEN }}
        run: |
          python - <<'PY'
          import os, tweepy, requests, sys
          text = os.getenv('INPUT_TEXT') or "Hello from Aging–DDR bot (setup test)."

          # Prefer OAuth2 if available
          cid = os.getenv('TWITTER_CLIENT_ID')
          csec = os.getenv('TWITTER_CLIENT_SECRET')
          rtok = os.getenv('TWITTER_REFRESH_TOKEN')

          def oauth2_post(text):
            import base64
            token_url = "https://api.twitter.com/2/oauth2/token"
            data = {"grant_type":"refresh_token","refresh_token":rtok,"client_id":cid}
            headers = {"Content-Type":"application/x-www-form-urlencoded"}
            if csec:
              basic = base64.b64encode(f"{cid}:{csec}".encode()).decode()
              headers["Authorization"] = f"Basic {basic}"
            tr = requests.post(token_url, data=data, headers=headers, timeout=20)
            print("refresh status:", tr.status_code)
            print("refresh body:", tr.text[:300])
            tr.raise_for_status()
            at = tr.json().get('access_token')
            pr = requests.post(
              "https://api.twitter.com/2/tweets",
              headers={"Authorization":f"Bearer {at}","Content-Type":"application/json"},
              json={"text": text}, timeout=20
            )
            print("post status:", pr.status_code)
            print("post body:", pr.text[:300])
            pr.raise_for_status()

          if cid and rtok:
            try:
              oauth2_post(text)
              sys.exit(0)
            except Exception as e:
              print("OAuth2 failed:", e)

          # Fallback to OAuth1 in v2 client
          ck = os.getenv('TWITTER_CONSUMER_KEY')
          cs = os.getenv('TWITTER_CONSUMER_SECRET')
          at = os.getenv('TWITTER_ACCESS_TOKEN')
          ats = os.getenv('TWITTER_ACCESS_TOKEN_SECRET')
          if not all([ck,cs,at,ats]):
            print("No valid auth found.")
            sys.exit(1)
          client = tweepy.Client(consumer_key=ck, consumer_secret=cs, access_token=at, access_token_secret=ats)
          resp = client.create_tweet(text=text)
          print("v2 fallback response:", resp)
          PY
